<!DOCTYPE html>
<html lang="zh-cn" class="h-100">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=10;IE=11">
    <meta http-equiv="Cache-Control" content="no-transform">
    <script>
      // 动态设置 base href，生产环境使用 /historymap/，本地开发使用 /
      if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
        document.write('<base href="/historymap/">');
      }
    </script>
    <title>唐宋文学编年地图</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/dist-jquery.min.js"></script>
    <script src="js/js-bootstrap.bundle.min.js"></script>
    <script src="js/echarts-echarts.min.js"></script>
    <script type="text/javascript" src="js/sheetjs-spreadsheet.min.js"></script>
    <script src="js/js-lib.js"></script>
    <link rel="stylesheet" href="css/css-common.css">
    <link rel="stylesheet" type="text/css" href="css/sheetjs-spreadsheet.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #ffffff;
        color: #333;
      }
      
      a {
      text-decoration: none;
      }
      
      /* 顶部搜索栏 */
      .top-search-bar {
        max-width: 1200px;
        margin: 2rem auto 1rem;
        padding: 0 1rem;
      }
      
      .search-input-wrapper {
        position: relative;
        width: 100%;
      }
      
      .search-input {
        width: 100%;
        padding: 1rem 3rem 1rem 1.5rem;
        border: 2px solid #e8e8e8;
        border-radius: 50px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #fafafa;
      }
      
      .search-input:focus {
        outline: none;
        border-color: #a855f7;
        background: #ffffff;
        box-shadow: 0 4px 12px rgba(168, 85, 247, 0.15);
      }
      
      .search-icon {
        position: absolute;
        right: 1.5rem;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
      }
      
      /* 选项卡容器 */
      .tabs-container {
        max-width: 1200px;
        margin: 0 auto 2rem;
        padding: 0 1rem;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .tabs-container::-webkit-scrollbar {
        height: 0;
      }
      
      .tabs-wrapper {
        display: flex;
        gap: 2rem;
        border-bottom: 1px solid #e8e8e8;
        min-width: max-content;
      }
      
      @media (min-width: 768px) {
        .tabs-wrapper {
          min-width: auto;
        }
      }
      
      .tab-item {
        position: relative;
        padding: 1rem 0.5rem;
        color: #999;
        font-weight: 500;
        cursor: pointer;
        transition: color 0.3s ease;
        white-space: nowrap;
        border-bottom: 3px solid transparent;
      }
      
      .tab-item:hover {
        color: #666;
      }
      
      .tab-item.active {
        color: #333;
        border-bottom-color: #000;
      }
      
      .tab-badge {
        position: absolute;
        top: 0.5rem;
        right: -1rem;
        background: linear-gradient(135deg, #ff6b6b, #ff8c42);
        color: white;
        font-size: 0.65rem;
        padding: 0.15rem 0.4rem;
        border-radius: 8px;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
      }
      
      /* 内容卡片区域 */
      .content-area {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem 2rem;
      }
      
      .tab-content {
        display: none;
      }
      
      .tab-content.active {
        display: block;
        animation: fadeIn 0.4s ease;
      }
      
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      .card-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      @media (min-width: 768px) {
        .card-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      
      @media (min-width: 1024px) {
        .card-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }
      
      .content-card {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
        border: 1px solid #f0f0f0;
      }
      
      .content-card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        transform: translateY(-4px);
      }
      
      .card-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
      }
      
      .card-description {
        color: #666;
        line-height: 1.6;
        font-size: 0.95rem;
      }
      
      /* 背景装饰 */
      .bg-decoration {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 300px;
        background: linear-gradient(135deg, rgba(255, 182, 193, 0.1), rgba(173, 216, 230, 0.15));
        z-index: -1;
        pointer-events: none;
      }
      
      /* 功能按钮 */
      .action-button {
        background: linear-gradient(135deg, #a855f7, #8b5cf6);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
      }
      
      .action-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(168, 85, 247, 0.4);
      }
      
      /* 地图容器样式 */
      .map-container {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
      }
      
      .map-full-width {
        width: 100%;
        height: 600px;
      }
      
      #poetLifeMapRegion {
        height: 600px;
        border-radius: 20px;
      }
      
      #poetLifeDetail {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        height: fit-content;
        min-height: 200px;
      }
      
      /* 优化地图和详情的布局 */
      .map-detail-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      @media (min-width: 1024px) {
        .map-detail-container {
          grid-template-columns: 2fr 1fr;
        }
      }
      
      #poetLifeSummary {
        display: none;
      }
      
      /* 隐藏原导航栏 */
      .navbar {
        display: none;
      }
      
      /* 侧边栏优化 */
      .offcanvas-body {
        background: white;
      }
    </style>
  </head>
  <body>
    <!-- 背景装饰 -->
    <div class="bg-decoration"></div>
    
    <!-- 顶部搜索栏 -->
    <div class="top-search-bar">
      <div class="search-input-wrapper">
        <input type="search" class="search-input" id="mainSearch" placeholder="搜索地点、人物、年份...">
        <span class="search-icon">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16zM18 18l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      </div>
    </div>
    
    <!-- 选项卡 -->
    <div class="tabs-container">
      <div class="tabs-wrapper">
        <div class="tab-item active" data-tab="sushi">
          苏轼被贬之路
        </div>
        <div class="tab-item" data-tab="xuxiake">
          徐霞客的苦难与辉煌之路
          <span class="tab-badge">New</span>
        </div>
      </div>
    </div>
    
    <!-- 内容区域 -->
    <div class="content-area">
      <!-- 苏轼选项卡内容 -->
      <div class="tab-content active" id="sushi-content">
        <div class="map-detail-container">
          <div class="map-container">
            <div id="poetLifeMapRegion" class="map-full-width"></div>
          </div>
          <div id="poetLifeDetail"></div>
        </div>
      </div>
      
      <!-- 徐霞客选项卡内容 -->
      <div class="tab-content" id="xuxiake-content">
        <div class="card-grid">
          <div class="content-card">
            <h3 class="card-title">徐霞客游记</h3>
            <p class="card-description">探索明代地理学家徐霞客的传奇游历路线，追寻他的足迹遍布祖国山河...</p>
          </div>
          <div class="content-card">
            <h3 class="card-title">即将推出</h3>
            <p class="card-description">更多精彩内容正在筹备中，敬请期待...</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 隐藏的原导航栏（保留功能） -->
    <nav class="navbar navbar-expand-lg navbar-light border-bottom" aria-label="主菜单" style="background-color: whitesmoke;">
      <div class="container-fluid">
        <a href="javascript: void(0)" class="me-lg-4 navbar-brand">
          <img src="images/images-logo.png" style="height: 56px;" class="me-3">
          <img src="images/images-sitename.png" style="height: 40px;">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#commonMenu" aria-controls="commonMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse mb-2 mb-lg-0" id="commonMenu">
          <div class="nav col-12 col-lg-auto me-lg-auto mb-2 justify-content-center mb-md-0">
            <a class="nav-link px-2 link-dark" href="javascript: NewView('scope=&author=苏轼&beginYear=0&endYear=0');">苏轼南贬之路</a>
          </div>
        </div>
      </div>
    </nav>
    
    <main role="main" class="pb-3 flex-shrink-0" id="main" style="display: none;">
      <style type="text/css">
        img.icon {
        height: 60px;
        }
        img.full {
        max-width: 600px;
        }
        img.inline {
        max-width: 40%;
        float: left;
        margin: 0 8px 8px 0;
        }
        td, th {
        text-align: left;
        }
        .marked {
        border: 2px solid gold;
        }
      </style>
      <script src="https://webapi.amap.com/maps?v=2.0&key=310b384ed020c49bb4727ae142294426"></script>
      <script src="https://webapi.amap.com/loca?v=2.0.0&key=310b384ed020c49bb4727ae142294426"></script>
      <div id="poetLifeSummary" class="bg-light text-secondary border container-fluid rounded" style="max-height: 484px; overflow-y: auto;"></div>
      <div class="offcanvas offcanvas-start d-flex " data-bs-scroll="true" tabindex="-1" id="menu" aria-labelledby="menuLabel">
        <div class="offcanvas-header border-bottom border-info">
          <h5 class="offcanvas-title" id="menuLabel">唐宋文学编年地图</h5>
          <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
          <form method="get" action="/Map/PoetLife">
            <div class="input-group my-3">
              <span class="input-group-text">从</span>
              <input type="search" class="form-control" placeholder="公元年或地名" id="Begin" name="Begin" value="">
            </div>
            <div class="input-group my-3">
              <span class="input-group-text">至</span>
              <input type="search" class="form-control" placeholder="公元年或地名" id="End" name="End" value="">
              <button class="btn btn-primary" type="submit">查询</button>
            </div>
          </form>
          <div class="input-group mt-3">
            <input name="key" id="key" type="search" class="form-control" placeholder="关键词">
            <button class="btn btn-primary" onclick="Filter()" type="button">搜索</button>
          </div>
          <div id="poetList">
            <div id="poetSearchBox" class="form-floating me-2 mb-3"></div>
            <div id="categoryList"></div>
          </div>
        </div>
      </div>
      <div class="container-fluid mt-3">
        <div class="row g-3">
          <div class="col-lg-8">
            <script src="js/js-poetlife.js"></script>
            <style>
              .amap-info-contentContainer {
                width: 400px;
                max-width: 400px;
              }
              .amap-info-content {
                width: 400px;
              }
            </style>
            <script type="text/javascript">
              var modernLayers = [];
              var lastLayer;
              isXianTang = false;
              
              $(document).ready(CreatePoetLifeMap);
              
              function ShowModernLayers() {
                  $.each(modernLayers, function(index, layer) {
                      map.addLayer(layer);
                  });
              }
              
              function SwitchTile() {
                  if (lastLayer) {
                      map.removeLayer(lastLayer);
                      lastLayer = null;
                  }
              
                  var tileName = document.getElementById("bgMap").value;
                  
                  if (tileName == "satellite") {
                      lastLayer = new AMap.TileLayer.Satellite();
                  }
              
                  if (lastLayer) {
                      map.addLayer(lastLayer);
                  }
              }
              
              function CreatePoetLifeMap() {
                  var dynasty = "";
                  beginYear = 0;
                  endYear = 0;
                  map = PrepareMap("poetLifeMapRegion", dynasty.length > 0 ? dynasty : null, modernLayers);
                  var loca = new Loca.Container({
                          map,
                      });
              
                  lightMarkLayer = new Loca.ScatterLayer({
                    zIndex: 120,
                    opacity: 0.7
                  });
                  lightMarkLayer.setSource(new Loca.GeoJSONSource({
                    data: {},
                  }));
                  lightMarkLayer.setStyle({
                    unit: 'px',
                    size: [80, 80],
                    texture: './map/breath_red.png',
                    animate: true,
                    duration: 1000,
                  });
                  loca.add(lightMarkLayer);
                  loca.animate.start();
              
                  var uploadedTrace = null;
                  if (uploadedTrace && uploadedTrace.Traces)
                  {
                      if (uploadedTrace.Traces.length == 1)
                      {
                          ShowTrace(uploadedTrace);
                      }
                      else
                      {
                          travelData = uploadedTrace;
                          for (var i = 0; i < uploadedTrace.Traces.length; i++) {
                              selectedPoets.push(i);
                          }
                          ShowSelectedPoetsRoute();
                      }
                  }
                  else
                  {
                      $.getJSON('./Api/travelData.json').done(function (data) {
                          travelData = data;
                      // 支持从 URL 读取作者与时间范围参数
                      var params = new URLSearchParams(location.search);
                      var author = params.get('author') || '';
                      var beginYearFromQuery = Number(params.get('beginYear') || 0);
                      var endYearFromQuery = Number(params.get('endYear') || 0);
              
                          ShowCategoryList(travelData.Traces);
                      if (author && author.length > 0) {
                          NewView("scope=&author=" + author + "&beginYear=" + beginYearFromQuery + "&endYear=" + endYearFromQuery);
                          }
                          else {
                              ShowTraceByIndex(0);
                          }
                      });
                  }
              }
            </script>
            <div style="position: relative;">
              <div id="poetLifeMapRegion" class="w-100 mapColumn"></div>
            </div>
          </div>
          <div class="col-lg-3">
            <div id="poetLifeDetail" class="column"></div>
          </div>
        </div>
      </div>
      <div class="offcanvas offcanvas-end" tabindex="-1" id="referedData" aria-labelledby="referedDataLabel" style="min-width: 50%;">
        <div class="offcanvas-header border-bottom border-info">
          <h5 class="offcanvas-title" id="referedDataLabel"></h5>
          <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body bg-default">
          <div class="container" id="referedContent"></div>
        </div>
      </div>
    </main>
    <footer class="border-top footer text-muted py-2 mt-auto" style="background-color: whitesmoke;">
      <div class="container-fluid">
        © 2025 - 唐宋文学编年地图
      </div>
    </footer>
    
    <!-- 选项卡切换脚本 -->
    <script>
      $(document).ready(function() {
        // 选项卡切换功能
        $('.tab-item').on('click', function() {
          const tabName = $(this).data('tab');
          
          // 更新选项卡激活状态
          $('.tab-item').removeClass('active');
          $(this).addClass('active');
          
          // 更新内容区域显示
          $('.tab-content').removeClass('active');
          $(`#${tabName}-content`).addClass('active');
        });
        
        // 搜索功能
        $('#mainSearch').on('keypress', function(e) {
          if (e.which === 13) { // Enter键
            const query = $(this).val().trim();
            if (query) {
              Filter();
              // 可以在这里添加更多搜索逻辑
            }
          }
        });
        
        // 自动加载苏轼地图
        setTimeout(function() {
          NewView('scope=&author=苏轼&beginYear=0&endYear=0');
        }, 500);
      });
    </script>
  </body>
</html>